<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Chương Trình Quay Số May Mắn</title>
    <meta http-equiv="Cache-Control" content="no-cache" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Expires" content="-1" />
    <meta
      name="description"
      content="Chương trình quay số may mắn"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Saira:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --gold: #ffd700;
        --gold-dark: #c5a000;
        --red-primary: #d50000;
        --red-dark: #820000;
        --red-light: #ff5252;
        --glass-bg: rgba(255, 255, 255, 0.12);
        --glass-border: rgba(255, 255, 255, 0.25);
        --shadow-strong: 0 8px 32px rgba(0, 0, 0, 0.4);
        --shadow-glow: 0 0 20px rgba(255, 215, 0, 0.4);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Saira", "Open Sans", sans-serif;
        background: #1a0000;
        color: #fff;
        min-height: 100vh;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* === BACKGROUND === */
      .background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        z-index: 0;
        filter: brightness(0.6);
      }

      /* === MAIN CONTAINER === */
      .main-container {
        position: relative;
        z-index: 1;
        width: 100%;
        max-width: 1000px;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        min-height: 100vh;
      }

      /* === HEADER === */
      .header {
        text-align: center;
        margin-top: 30px;
        margin-bottom: 20px;
      }

      .header h1 {
        font-size: clamp(32px, 6vw, 64px);
        font-weight: 900;
        color: var(--gold);
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.6),
          0 0 30px rgba(255, 215, 0, 0.3), 2px 2px 4px rgba(0, 0, 0, 0.8);
        letter-spacing: 3px;
        line-height: 1.1;
      }

      .header h3 {
        font-size: clamp(18px, 3.5vw, 36px);
        font-weight: 700;
        color: #fff;
        text-shadow: 0 0 15px rgba(255, 82, 82, 0.6),
          2px 2px 4px rgba(0, 0, 0, 0.8);
        margin-top: 8px;
        letter-spacing: 2px;
      }

      /* === PRIZE INFO === */
      .prize-info {
        text-align: center;
        margin-bottom: 15px;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .prize-title {
        font-size: clamp(22px, 4vw, 40px);
        font-weight: 900;
        color: var(--gold);
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.5),
          2px 2px 4px rgba(0, 0, 0, 0.8);
        text-transform: uppercase;
      }

      .prize-gift {
        font-size: clamp(16px, 3vw, 28px);
        font-weight: 700;
        color: #fff;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
        margin-top: 4px;
      }

      /* === LUCKY NUMBER AREA === */
      .lucky-area {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 30px;
        margin-bottom: 20px;
        width: 100%;
      }

      .side-list {
        flex: 0 0 120px;
        max-height: 380px;
        overflow-y: auto;
        overflow-x: hidden;
        text-align: center;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 215, 0, 0.4) transparent;
      }

      .side-list::-webkit-scrollbar {
        width: 4px;
      }

      .side-list::-webkit-scrollbar-thumb {
        background: rgba(255, 215, 0, 0.4);
        border-radius: 2px;
      }

      .side-list p {
        font-size: 22px;
        font-weight: 800;
        color: var(--gold);
        margin-bottom: 4px;
        text-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
        transition: all 0.3s ease;
      }

      .side-list p:last-child {
        animation: fadeInNumber 0.5s ease;
      }

      @keyframes fadeInNumber {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* === NUMBER DISPLAY === */
      .number-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }

      .number-display {
        display: flex;
        gap: 8px;
      }

      .number-cell {
        width: clamp(50px, 10vw, 80px);
        height: clamp(65px, 13vw, 100px);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: clamp(36px, 7vw, 64px);
        font-weight: 900;
        color: var(--red-primary);
        background: linear-gradient(145deg, #ffe44d, #ffd700, #ffc107, #ffb300);
        border-radius: 12px;
        border: 3px solid rgba(255, 255, 255, 0.4);
        box-shadow: var(--shadow-glow), inset 0 2px 4px rgba(255, 255, 255, 0.5),
          0 4px 8px rgba(0, 0, 0, 0.3);
        transition: transform 0.1s ease;
        user-select: none;
      }

      .number-cell.spinning {
        animation: pulse 0.15s ease-in-out infinite alternate;
      }

      .number-cell.stopped {
        animation: stampIn 0.3s ease-out;
        transform: scale(1.05);
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.7),
          inset 0 2px 4px rgba(255, 255, 255, 0.5), 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      @keyframes pulse {
        from {
          transform: scale(1);
        }
        to {
          transform: scale(1.03);
        }
      }

      @keyframes stampIn {
        0% {
          transform: scale(1.3);
        }
        50% {
          transform: scale(0.95);
        }
        100% {
          transform: scale(1.05);
        }
      }

      /* === BUTTONS === */
      .btn-start {
        display: inline-block;
        padding: 12px 50px;
        font-size: clamp(24px, 4vw, 36px);
        font-weight: 900;
        color: #fff;
        text-decoration: none;
        background: linear-gradient(135deg, #ff5722, #d50000);
        border: none;
        border-radius: 12px;
        box-shadow: 0 6px 0 var(--red-dark), 0 10px 20px rgba(0, 0, 0, 0.4);
        cursor: pointer;
        transition: all 0.1s ease;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        letter-spacing: 3px;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      .btn-start:hover {
        background: linear-gradient(135deg, #ff6d3b, #e52020);
        box-shadow: 0 6px 0 var(--red-dark), 0 12px 25px rgba(0, 0, 0, 0.5);
        transform: translateY(-2px);
      }

      .btn-start:active {
        transform: translateY(4px);
        box-shadow: 0 2px 0 var(--red-dark), 0 4px 10px rgba(0, 0, 0, 0.4);
      }

      .btn-start.disabled {
        opacity: 0.5;
        pointer-events: none;
      }

      /* === CONTROL BAR (bottom-right corner) === */
      .control-bar {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 10;
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-end;
      }

      .ctrl-btn {
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 700;
        border: 2px solid var(--glass-border);
        border-radius: 8px;
        background: var(--glass-bg);
        color: #fff;
        cursor: pointer;
        transition: all 0.25s ease;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        white-space: nowrap;
      }

      .ctrl-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: var(--gold);
        color: var(--gold);
        box-shadow: 0 0 12px rgba(255, 215, 0, 0.2);
      }

      .ctrl-btn.active {
        background: rgba(255, 215, 0, 0.2);
        border-color: var(--gold);
        color: var(--gold);
      }

      /* === NAV BUTTONS === */
      .nav-buttons {
        display: flex;
        gap: 12px;
        margin-top: 5px;
      }

      .btn-next {
        padding: 8px 24px;
        font-size: 16px;
        font-weight: 700;
        border: 2px solid var(--gold);
        border-radius: 8px;
        background: rgba(255, 215, 0, 0.15);
        color: var(--gold);
        cursor: pointer;
        transition: all 0.25s ease;
      }

      .btn-next:hover {
        background: rgba(255, 215, 0, 0.3);
        box-shadow: 0 0 12px rgba(255, 215, 0, 0.3);
      }

      .btn-next:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        box-shadow: none;
      }

      /* === COUNTER BADGE === */
      .counter-badge {
        font-size: 14px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.7);
        background: rgba(0, 0, 0, 0.3);
        padding: 4px 12px;
        border-radius: 20px;
        margin-top: 8px;
      }

      /* === RESPONSIVE === */
      @media (max-width: 768px) {
        .lucky-area {
          gap: 10px;
        }

        .side-list {
          flex: 0 0 70px;
          max-height: 260px;
        }

        .side-list p {
          font-size: 16px;
        }

        .number-display {
          gap: 5px;
        }

        .control-bar {
          gap: 6px;
        }

        .ctrl-btn {
          padding: 6px 12px;
          font-size: 12px;
        }
      }

      @media (max-width: 480px) {
        .main-container {
          padding: 10px;
        }

        .header {
          margin-top: 15px;
          margin-bottom: 10px;
        }

        .side-list {
          flex: 0 0 55px;
          max-height: 200px;
        }

        .side-list p {
          font-size: 14px;
        }

        .number-cell {
          border-radius: 8px;
          border-width: 2px;
        }

        .btn-start {
          padding: 10px 35px;
          letter-spacing: 2px;
        }

        .result-panel {
          padding: 12px;
        }

        .result-prize-name {
          font-size: 16px;
        }

        .result-numbers {
          font-size: 15px;
        }
      }

      /* === CONFIG OVERLAY === */
      .config-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 100;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        overflow-y: auto;
        padding: 30px 15px;
      }

      .config-overlay.show {
        display: flex;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .config-panel {
        width: 100%;
        max-width: 800px;
        background: rgba(30, 10, 10, 0.95);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 30px;
        color: #fff;
        align-self: flex-start;
      }

      .config-panel h2 {
        text-align: center;
        color: var(--gold);
        font-weight: 900;
        font-size: 24px;
        margin-bottom: 24px;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
      }

      .config-section {
        margin-bottom: 24px;
      }

      .config-section h3 {
        color: var(--gold);
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 12px;
        border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        padding-bottom: 6px;
      }

      .config-row {
        display: flex;
        gap: 12px;
        margin-bottom: 10px;
        align-items: center;
      }

      .config-row label {
        flex: 0 0 140px;
        font-size: 14px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.8);
      }

      .config-input {
        flex: 1;
        padding: 8px 12px;
        font-size: 14px;
        font-family: inherit;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: #fff;
        outline: none;
        transition: border-color 0.2s;
      }

      .config-input:focus {
        border-color: var(--gold);
      }

      .config-input::placeholder {
        color: rgba(255, 255, 255, 0.3);
      }

      textarea.config-input {
        resize: vertical;
        min-height: 60px;
      }

      /* Prize table */
      .prize-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .prize-table th {
        background: rgba(255, 215, 0, 0.15);
        color: var(--gold);
        padding: 8px 6px;
        text-align: center;
        font-weight: 700;
        font-size: 12px;
        border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        white-space: nowrap;
      }

      .prize-table td {
        padding: 6px 4px;
        text-align: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        vertical-align: middle;
      }

      .prize-table .row-input {
        width: 100%;
        padding: 6px 8px;
        font-size: 13px;
        font-family: inherit;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 4px;
        color: #fff;
        outline: none;
        transition: border-color 0.2s;
      }

      .prize-table .row-input:focus {
        border-color: var(--gold);
      }

      .prize-table .col-stt {
        width: 40px;
      }
      .prize-table .col-title {
        width: 35%;
      }
      .prize-table .col-gift {
        width: 30%;
      }
      .prize-table .col-max {
        width: 100px;
      }
      .prize-table .col-batch {
        width: 70px;
      }
      .prize-table .col-hl {
        width: 70px;
      }
      .prize-table .col-actions {
        width: 100px;
      }

      .row-actions {
        display: flex;
        gap: 3px;
        justify-content: center;
      }

      .row-btn {
        width: 26px;
        height: 26px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        transition: all 0.2s;
      }

      .row-btn:hover {
        background: rgba(255, 255, 255, 0.25);
      }

      .row-btn.delete:hover {
        background: rgba(255, 0, 0, 0.3);
        color: #ff5252;
      }

      .config-footer {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .cfg-btn {
        padding: 10px 24px;
        font-size: 14px;
        font-weight: 700;
        font-family: inherit;
        border: 2px solid var(--glass-border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--glass-bg);
        color: #fff;
      }

      .cfg-btn:hover {
        border-color: var(--gold);
        color: var(--gold);
      }

      .cfg-btn.primary {
        background: rgba(255, 215, 0, 0.2);
        border-color: var(--gold);
        color: var(--gold);
      }

      .cfg-btn.primary:hover {
        background: rgba(255, 215, 0, 0.35);
      }

      .cfg-btn.danger {
        border-color: rgba(255, 82, 82, 0.4);
        color: rgba(255, 82, 82, 0.8);
      }

      .cfg-btn.danger:hover {
        background: rgba(255, 82, 82, 0.15);
        border-color: #ff5252;
        color: #ff5252;
      }

      .add-row-btn {
        display: block;
        width: 100%;
        padding: 8px;
        margin-top: 8px;
        font-size: 13px;
        font-weight: 700;
        font-family: inherit;
        border: 2px dashed rgba(255, 215, 0, 0.3);
        border-radius: 6px;
        background: transparent;
        color: var(--gold);
        cursor: pointer;
        transition: all 0.2s;
      }

      .add-row-btn:hover {
        border-color: var(--gold);
        background: rgba(255, 215, 0, 0.08);
      }

      .table-scroll {
        max-height: 400px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 215, 0, 0.3) transparent;
      }

      @media (max-width: 600px) {
        .config-panel {
          padding: 16px;
        }
        .config-row {
          flex-direction: column;
          gap: 4px;
        }
        .config-row label {
          flex: none;
        }
        .prize-table .col-title {
          width: auto;
        }
        .prize-table .col-gift {
          width: auto;
        }
        .cfg-btn {
          padding: 8px 16px;
          font-size: 13px;
        }
      }

      /* === FIREWORKS CANVAS === */
      .fireworks-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 0;
        pointer-events: none;
      }

      /* === DECORATIVE === */
      .sparkle-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        background: radial-gradient(
            circle at 20% 80%,
            rgba(255, 215, 0, 0.05) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 20%,
            rgba(255, 82, 82, 0.05) 0%,
            transparent 50%
          );
      }
    </style>
  </head>

  <body>
    <img src="./background/background1.jpg" class="background" alt="background" />
    <canvas id="fireworks-canvas" class="fireworks-canvas"></canvas>
    <div class="sparkle-overlay"></div>

    <div class="main-container">
      <!-- HEADER -->
      <div class="header">
        <h1 id="org-name">TÊN TỔ CHỨC</h1>
        <h3 id="program-title">CHƯƠNG TRÌNH QUAY SỐ</h3>
      </div>

      <!-- PRIZE INFO -->
      <div class="prize-info">
        <div class="prize-title" id="title-spin"></div>
        <div class="prize-gift" id="title-value"></div>
      </div>

      <!-- LUCKY NUMBER AREA -->
      <div class="lucky-area" id="group-lucky">
        <div class="side-list" id="left-list"></div>

        <div class="number-container">
          <div class="number-display">
            <div class="number-cell" id="no1">0</div>
            <div class="number-cell" id="no2">0</div>
            <div class="number-cell" id="no3">0</div>
            <div class="number-cell" id="no4">0</div>
            <div class="number-cell" id="no5">0</div>
          </div>

          <!-- START BUTTON -->
          <div id="start">
            <button class="btn-start" onclick="startDraw()">QUAY SỐ</button>
          </div>

          <!-- COUNTER -->
          <div class="counter-badge" id="counter-badge"></div>
        </div>

        <div class="side-list" id="right-list"></div>
      </div>

      <!-- NAVIGATION -->
      <div class="nav-buttons">
        <button class="btn-next" onclick="prevSpin()">
          &#9664; Giải trước
        </button>
        <button class="btn-next" onclick="nextSpin()">Giải tiếp &#9654;</button>
      </div>

    </div>

    <!-- CONFIG OVERLAY -->
    <div class="config-overlay" id="config-overlay">
      <div class="config-panel">
        <h2>CẤU HÌNH CHƯƠNG TRÌNH</h2>

        <div class="config-section">
          <h3>Cài đặt chung</h3>
          <div class="config-row">
            <label>Tên tổ chức</label>
            <input
              type="text"
              class="config-input"
              id="cfg-org-name"
              placeholder="VD: GIÁO XỨ NAM LỖ"
            />
          </div>
          <div class="config-row">
            <label>Tên chương trình</label>
            <input
              type="text"
              class="config-input"
              id="cfg-program-title"
              placeholder="VD: CHƯƠNG TRÌNH QUAY SỐ 2026"
            />
          </div>
          <div class="config-row">
            <label>Số lớn nhất (MAX)</label>
            <input
              type="number"
              class="config-input"
              id="cfg-max"
              min="10"
              max="99999"
            />
          </div>
          <div class="config-row">
            <label>Số không tham gia</label>
            <textarea
              class="config-input"
              id="cfg-ignore"
              placeholder="VD: 1001, 2002, 3003 (phân cách bằng dấu phẩy)"
            ></textarea>
          </div>
        </div>

        <div class="config-section">
          <h3>Danh sách giải thưởng</h3>
          <div class="table-scroll">
            <table class="prize-table">
              <thead>
                <tr>
                  <th class="col-stt">#</th>
                  <th class="col-title">Tên giải</th>
                  <th class="col-gift">Phần thưởng</th>
                  <th class="col-max">SL</th>
                  <th class="col-batch">Quay/lượt</th>
                  <th class="col-hl">Nổi bật</th>
                  <th class="col-actions"></th>
                </tr>
              </thead>
              <tbody id="cfg-prize-body"></tbody>
            </table>
          </div>
          <button class="add-row-btn" onclick="addPrizeRow()">
            + Thêm giải
          </button>
        </div>

        <div class="config-footer">
          <button class="cfg-btn primary" onclick="saveConfig()">
            Lưu &amp; Đóng
          </button>
          <button class="cfg-btn danger" onclick="resetDefaults()">
            Đặt lại mặc định
          </button>
          <button class="cfg-btn" onclick="closeConfig()">Đóng</button>
        </div>
      </div>
    </div>

    <!-- CONTROL BAR (bottom-right) -->
    <div class="control-bar">
      <button
        class="ctrl-btn active"
        id="fireworksBtn"
        onclick="toggleFireworks()"
      >
        &#127878; Pháo hoa
      </button>
      <button class="ctrl-btn" onclick="openConfig()">&#9881; Cấu hình</button>
      <button class="ctrl-btn" id="startMusic" onclick="toggleMusic()">
        &#127925; Nhạc nền
      </button>
      <button class="ctrl-btn" onclick="window.open('./KET QUA.html','_blank')">
        &#128203; Kết quả
      </button>
      <button class="ctrl-btn" onclick="exportResult()">
        &#128190; Xuất CSV
      </button>
      <select class="ctrl-btn" id="bgSelect" onchange="changeBackground(this.value)" style="cursor:pointer;appearance:auto;-webkit-appearance:menulist;padding-right:6px;">
        <option value="./background/background1.jpg">Loading...</option>
      </select>
    </div>

    <audio id="backgroundMusic" loop src="./music.mp3"></audio>
    <audio id="spinSound" src="./spinwheel.mp3"></audio>

    <script>
      // === CẤU HÌNH MẶC ĐỊNH ===
      var DEFAULT_ORG_NAME = "TÊN TỔ CHỨC";
      var DEFAULT_PROGRAM_TITLE = "CHƯƠNG TRÌNH QUAY SỐ";
      var DEFAULT_DATA = [
        { title: "Giải khuyến khích", gift: "10 phần quà", max: 10, batch: 5, highlight: 0 },
        { title: "Giải ba", gift: "3 phần quà", max: 3, batch: 1, highlight: 0 },
        { title: "Giải nhì", gift: "2 phần quà", max: 2, batch: 1, highlight: 0 },
        { title: "Giải nhất", gift: "1 phần quà", max: 1, batch: 1, highlight: 1 },
        { title: "Giải đặc biệt", gift: "1 phần quà đặc biệt", max: 1, batch: 1, highlight: 2 },
      ];
      var DEFAULT_MAX = 5001;
      var DEFAULT_IGNORE = [];

      var data = [];
      var nowSpin = 0;
      var ignoreNumbers = [];
      var MAX = DEFAULT_MAX;
      var disabled = false;
      var musicPlaying = false;
      var configPrizes = []; // Working copy for config editor
      var DEFAULT_BG = "./background/background1.jpg";

      // === KHỞI TẠO ===
      window.onload = function () {
        loadConfig();
        document.getElementById("title-spin").innerText = data[nowSpin].title;
        document.getElementById("title-value").innerText = data[nowSpin].gift;
        updateCounter();
      };

      function loadConfig() {
        // Load org name & program title
        var savedOrg = localStorage.getItem("configOrgName");
        var savedProgram = localStorage.getItem("configProgramTitle");
        var orgName = savedOrg || DEFAULT_ORG_NAME;
        var programTitle = savedProgram || DEFAULT_PROGRAM_TITLE;
        document.getElementById("org-name").innerText = orgName;
        document.getElementById("program-title").innerText = programTitle;

        // Load prize config
        var savedConfig = localStorage.getItem("configData");
        var prizes = null;
        if (savedConfig) {
          try {
            prizes = JSON.parse(savedConfig);
          } catch (e) {}
        }
        if (!prizes || !Array.isArray(prizes) || prizes.length === 0) {
          prizes = DEFAULT_DATA.map(function (p) {
            return {
              title: p.title,
              gift: p.gift,
              max: p.max,
              batch: p.batch || 1,
              highlight: p.highlight || 0,
            };
          });
        }

        // Load MAX
        var savedMax = localStorage.getItem("configMax");
        MAX = savedMax ? parseInt(savedMax, 10) || DEFAULT_MAX : DEFAULT_MAX;

        // Load ignore numbers
        var savedIgnore = localStorage.getItem("configIgnore");
        if (savedIgnore) {
          try {
            ignoreNumbers = JSON.parse(savedIgnore);
          } catch (e) {
            ignoreNumbers = DEFAULT_IGNORE.slice();
          }
        } else {
          ignoreNumbers = DEFAULT_IGNORE.slice();
        }

        // Load background
        var savedBg = localStorage.getItem("configBackground");
        var bgSrc = savedBg || DEFAULT_BG;
        document.querySelector(".background").src = bgSrc;

        // Build data array with number arrays
        // Try to restore draw results
        var savedResults = localStorage.getItem("data");
        var oldResults = null;
        if (savedResults) {
          try {
            oldResults = JSON.parse(savedResults);
          } catch (e) {}
        }

        data = prizes.map(function (p, i) {
          var numbers = [];
          // Restore numbers if old results match this slot
          if (oldResults && oldResults[i] && oldResults[i].title === p.title) {
            numbers = oldResults[i].number || [];
          }
          return {
            title: p.title,
            gift: p.gift,
            max: p.max,
            batch: p.batch || 1,
            highlight: p.highlight || 0,
            number: numbers,
          };
        });

        nowSpin = 0;
      }

      // === CHUYỂN GIẢI ===
      function goToSpin(index) {
        nowSpin = index;
        document.getElementById("title-spin").innerText = data[nowSpin].title;
        document.getElementById("title-value").innerText = data[nowSpin].gift;
        updateLists();
        updateCounter();

        // Hiển thị số cuối cùng đã quay (nếu có)
        var lastNum =
          data[nowSpin].number.length > 0
            ? getTextNumber(
                data[nowSpin].number[data[nowSpin].number.length - 1]
              )
            : "00000";
        for (var i = 1; i <= 5; i++) {
          var cell = document.getElementById("no" + i);
          cell.innerText = lastNum[i - 1];
          cell.classList.remove("stopped", "spinning");
        }
      }

      function nextSpin() {
        if (nowSpin >= data.length - 1) return;
        goToSpin(nowSpin + 1);
      }

      function prevSpin() {
        if (nowSpin <= 0) return;
        goToSpin(nowSpin - 1);
      }

      // === CẬP NHẬT DANH SÁCH 2 BÊN ===
      function updateLists() {
        var leftList = document.getElementById("left-list");
        var rightList = document.getElementById("right-list");

        if (leftList) leftList.innerHTML = "";
        if (rightList) rightList.innerHTML = "";

        if (data[nowSpin].max > 1) {
          data[nowSpin].number.forEach(function (num, index) {
            var p = document.createElement("p");
            p.textContent = getTextNumber(num);
            if (index % 2 === 0) {
              leftList.appendChild(p);
            } else {
              rightList.appendChild(p);
            }
          });
          // Cuộn xuống cuối
          leftList.scrollTop = leftList.scrollHeight;
          rightList.scrollTop = rightList.scrollHeight;
        }
      }

      // === CẬP NHẬT BỘ ĐẾM ===
      function updateCounter() {
        var badge = document.getElementById("counter-badge");
        var current = data[nowSpin].number.length;
        var total = data[nowSpin].max;
        badge.innerText = "Lượt quay: " + current + " / " + total;
      }

      // === QUAY SỐ ===
      function startDraw() {
        if (disabled || data[nowSpin].number.length >= data[nowSpin].max)
          return;
        disabled = true;

        // Phát âm thanh quay số
        var spinSound = document.getElementById("spinSound");
        spinSound.currentTime = 0;
        spinSound.play().catch(function () {});

        var remaining = data[nowSpin].max - data[nowSpin].number.length;
        var batch = Math.min(data[nowSpin].batch || 1, remaining);

        if (batch <= 1) {
          drawSingleNumber(function () {
            spinSound.pause();
            spinSound.currentTime = 0;
            disabled = false;
          });
        } else {
          drawBatchNumbers(batch, function () {
            spinSound.pause();
            spinSound.currentTime = 0;
            disabled = false;
          });
        }
      }

      function drawSingleNumber(callback) {
        var numberText = getTextNumber();
        var cells = [];
        var intervals = [];

        for (var i = 1; i <= 5; i++) {
          (function (idx) {
            var cell = document.getElementById("no" + idx);
            cell.classList.add("spinning");
            cell.classList.remove("stopped");
            var current = 0;
            var speed = 60 + idx * 10;
            intervals[idx] = setInterval(function () {
              cell.innerText = current;
              current = (current + 1) % 10;
            }, speed);
            cells[idx] = cell;
          })(i);
        }

        for (var i = 1; i <= 5; i++) {
          (function (idx) {
            setTimeout(function () {
              clearInterval(intervals[idx]);
              cells[idx].innerText = numberText[idx - 1];
              cells[idx].classList.remove("spinning");
              cells[idx].classList.add("stopped");
            }, idx * 800 + 400);
          })(i);
        }

        setTimeout(function () {
          updateLists();
          updateCounter();
          localStorage.setItem("data", JSON.stringify(data));
          localStorage.setItem("ignoreNumbers", JSON.stringify(ignoreNumbers));
          if (callback) callback();
        }, 5 * 800 + 600);
      }

      function drawBatchNumbers(batch, callback) {
        // Tạo tất cả số trước
        var numbers = [];
        for (var b = 0; b < batch; b++) {
          numbers.push(getTextNumber());
        }

        var SPIN_TIME = 1200; // Thời gian quay mỗi số (ms)
        var currentIndex = 0;

        function animateNext() {
          if (currentIndex >= numbers.length) {
            updateLists();
            updateCounter();
            localStorage.setItem("data", JSON.stringify(data));
            localStorage.setItem(
              "ignoreNumbers",
              JSON.stringify(ignoreNumbers)
            );
            if (callback) callback();
            return;
          }

          var numberText = numbers[currentIndex];
          var cells = [];
          var intervals = [];

          // Bắt đầu quay
          for (var i = 1; i <= 5; i++) {
            (function (idx) {
              var cell = document.getElementById("no" + idx);
              cell.classList.add("spinning");
              cell.classList.remove("stopped");
              var current = 0;
              var speed = 50 + idx * 8;
              intervals[idx] = setInterval(function () {
                cell.innerText = current;
                current = (current + 1) % 10;
              }, speed);
              cells[idx] = cell;
            })(i);
          }

          // Dừng nhanh hơn cho batch
          for (var i = 1; i <= 5; i++) {
            (function (idx) {
              setTimeout(function () {
                clearInterval(intervals[idx]);
                cells[idx].innerText = numberText[idx - 1];
                cells[idx].classList.remove("spinning");
                cells[idx].classList.add("stopped");
              }, idx * 150 + 200);
            })(i);
          }

          // Cập nhật danh sách bên + chuyển số tiếp theo
          setTimeout(function () {
            updateLists();
            updateCounter();
            currentIndex++;
            animateNext();
          }, SPIN_TIME);
        }

        animateNext();
      }

      // === TẠO SỐ NGẪU NHIÊN ===
      function generateRandomNumber() {
        var randomNumber;
        do {
          randomNumber = Math.floor(Math.random() * MAX);
        } while (ignoreNumbers.includes(randomNumber));
        ignoreNumbers.push(randomNumber);
        data[nowSpin].number.push(randomNumber);
        return randomNumber;
      }

      // === CHUYỂN SỐ THÀNH CHUỖI 5 CHỮ SỐ ===
      function getTextNumber(dataPr) {
        var num = dataPr !== undefined ? dataPr : generateRandomNumber();
        return String(num).padStart(5, "0");
      }

      // === BẬT/TẮT NHẠC ===
      function toggleMusic() {
        var music = document.getElementById("backgroundMusic");
        var btn = document.getElementById("startMusic");
        if (musicPlaying) {
          music.pause();
          btn.classList.remove("active");
          musicPlaying = false;
        } else {
          music.volume = 0.3;
          music
            .play()
            .then(function () {
              btn.classList.add("active");
              musicPlaying = true;
            })
            .catch(function (error) {
              console.error("Lỗi phát nhạc:", error);
            });
        }
      }

      // === CHỌN HÌNH NỀN ===
      function changeBackground(val) {
        document.querySelector(".background").src = val;
        localStorage.setItem("configBackground", val);
      }

      // Auto-scan background folder
      var BG_EXTENSIONS = [".jpg", ".jpeg", ".png", ".webp"];
      var bgList = [];

      function scanBackgrounds() {
        var select = document.getElementById("bgSelect");
        var savedBg = localStorage.getItem("configBackground") || DEFAULT_BG;
        var index = 1;
        var maxFails = 0;

        function tryNext() {
          if (maxFails >= 3) {
            // Done scanning - rebuild dropdown
            buildBgDropdown(savedBg);
            return;
          }
          tryExtensions(index, function (found) {
            if (found) {
              bgList.push(found);
              maxFails = 0;
            } else {
              maxFails++;
            }
            index++;
            tryNext();
          });
        }

        function tryExtensions(n, callback) {
          var exts = BG_EXTENSIONS.slice();
          function tryOne() {
            if (exts.length === 0) { callback(null); return; }
            var ext = exts.shift();
            var path = "./background/background" + n + ext;
            var img = new Image();
            img.onload = function () { callback(path); };
            img.onerror = function () { tryOne(); };
            img.src = path;
          }
          tryOne();
        }

        tryNext();
      }

      function buildBgDropdown(savedBg) {
        var select = document.getElementById("bgSelect");
        select.innerHTML = "";
        bgList.forEach(function (path, i) {
          var opt = document.createElement("option");
          opt.value = path;
          opt.textContent = "BG " + (i + 1);
          select.appendChild(opt);
        });
        // Set saved value
        if (savedBg) select.value = savedBg;
        // If saved value not in list, use first
        if (select.selectedIndex < 0 && bgList.length > 0) {
          select.value = bgList[0];
        }
      }

      scanBackgrounds();

      // === XUẤT CSV ===
      function exportResult() {
        var orgName = localStorage.getItem("configOrgName") || DEFAULT_ORG_NAME;
        var programTitle = localStorage.getItem("configProgramTitle") || DEFAULT_PROGRAM_TITLE;
        var csvContent = "Kết quả " + programTitle + " - " + orgName + "\n";
        csvContent +=
          data
            .map(function (item) {
              return item.title;
            })
            .join(",") + "\n";
        var maxNumbers = Math.max.apply(
          null,
          data.map(function (item) {
            return item.number.length;
          })
        );
        for (var i = 0; i < maxNumbers; i++) {
          csvContent +=
            data
              .map(function (item) {
                return item.number[i] !== undefined
                  ? getTextNumber(item.number[i])
                  : "";
              })
              .join(",") + "\n";
        }
        var blob = new Blob(["\uFEFF" + csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        var link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "KetQuaQuaySo.csv";
        link.click();
      }

      // === CẤU HÌNH ===
      function openConfig() {
        configPrizes = data.map(function (p) {
          return {
            title: p.title,
            gift: p.gift,
            max: p.max,
            batch: p.batch || 1,
            highlight: p.highlight || 0,
          };
        });
        document.getElementById("cfg-org-name").value =
          localStorage.getItem("configOrgName") || DEFAULT_ORG_NAME;
        document.getElementById("cfg-program-title").value =
          localStorage.getItem("configProgramTitle") || DEFAULT_PROGRAM_TITLE;
        document.getElementById("cfg-max").value = MAX;
        document.getElementById("cfg-ignore").value = ignoreNumbers.join(", ");
        renderConfigTable();
        document.getElementById("config-overlay").classList.add("show");
      }

      function closeConfig() {
        document.getElementById("config-overlay").classList.remove("show");
      }

      function renderConfigTable() {
        var tbody = document.getElementById("cfg-prize-body");
        tbody.innerHTML = "";
        configPrizes.forEach(function (prize, i) {
          var tr = document.createElement("tr");
          tr.innerHTML =
            '<td class="col-stt">' +
            (i + 1) +
            "</td>" +
            '<td class="col-title"><input class="row-input" value="' +
            escHtml(prize.title) +
            '" onchange="configPrizes[' +
            i +
            '].title=this.value" /></td>' +
            '<td class="col-gift"><input class="row-input" value="' +
            escHtml(prize.gift) +
            '" onchange="configPrizes[' +
            i +
            '].gift=this.value" /></td>' +
            '<td class="col-max"><input class="row-input" type="number" min="1" value="' +
            prize.max +
            '" onchange="configPrizes[' +
            i +
            '].max=parseInt(this.value)||1" style="text-align:center" /></td>' +
            '<td class="col-batch"><input class="row-input" type="number" min="1" value="' +
            (prize.batch || 1) +
            '" onchange="configPrizes[' +
            i +
            '].batch=parseInt(this.value)||1" style="text-align:center" /></td>' +
            '<td class="col-hl"><select class="row-input" onchange="configPrizes[' +
            i +
            '].highlight=parseInt(this.value)" style="text-align:center;padding:4px">' +
            '<option value="0"' + (prize.highlight === 0 ? ' selected' : '') + '>---</option>' +
            '<option value="1"' + (prize.highlight === 1 ? ' selected' : '') + '>&#9733;</option>' +
            '<option value="2"' + (prize.highlight === 2 ? ' selected' : '') + '>&#9733;&#9733;</option>' +
            '</select></td>' +
            '<td class="col-actions"><div class="row-actions">' +
            '<button class="row-btn" onclick="movePrizeRow(' +
            i +
            ',-1)" title="Lên">&#9650;</button>' +
            '<button class="row-btn" onclick="movePrizeRow(' +
            i +
            ',1)" title="Xuống">&#9660;</button>' +
            '<button class="row-btn delete" onclick="deletePrizeRow(' +
            i +
            ')" title="Xóa">&#10005;</button>' +
            "</div></td>";
          tbody.appendChild(tr);
        });
      }

      function escHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/"/g, "&quot;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function addPrizeRow() {
        configPrizes.push({ title: "", gift: "", max: 1, batch: 1, highlight: 0 });
        renderConfigTable();
        // Scroll to bottom
        var scroll = document.querySelector(".table-scroll");
        if (scroll) scroll.scrollTop = scroll.scrollHeight;
      }

      function deletePrizeRow(index) {
        if (configPrizes.length <= 1) return;
        if (!confirm('Xóa giải "' + configPrizes[index].title + '"?')) return;
        configPrizes.splice(index, 1);
        renderConfigTable();
      }

      function movePrizeRow(index, direction) {
        var newIndex = index + direction;
        if (newIndex < 0 || newIndex >= configPrizes.length) return;
        var temp = configPrizes[index];
        configPrizes[index] = configPrizes[newIndex];
        configPrizes[newIndex] = temp;
        renderConfigTable();
      }

      function saveConfig() {
        // Read values from inputs (in case onchange hasn't fired)
        var rows = document.querySelectorAll("#cfg-prize-body tr");
        rows.forEach(function (row, i) {
          var inputs = row.querySelectorAll(".row-input");
          if (inputs.length >= 5 && configPrizes[i]) {
            configPrizes[i].title = inputs[0].value.trim();
            configPrizes[i].gift = inputs[1].value.trim();
            configPrizes[i].max = parseInt(inputs[2].value, 10) || 1;
            configPrizes[i].batch = parseInt(inputs[3].value, 10) || 1;
            configPrizes[i].highlight = parseInt(inputs[4].value, 10) || 0;
          }
        });

        // Validate
        var valid = configPrizes.filter(function (p) {
          return p.title.length > 0;
        });
        if (valid.length === 0) {
          alert("Cần có ít nhất 1 giải thưởng!");
          return;
        }

        // Save MAX
        var newMax = parseInt(document.getElementById("cfg-max").value, 10);
        if (!newMax || newMax < 10) {
          alert("Số lớn nhất phải >= 10!");
          return;
        }
        MAX = newMax;

        // Save ignore numbers
        var ignoreText = document.getElementById("cfg-ignore").value.trim();
        if (ignoreText.length > 0) {
          ignoreNumbers = ignoreText
            .split(",")
            .map(function (s) {
              return parseInt(s.trim(), 10);
            })
            .filter(function (n) {
              return !isNaN(n);
            });
        } else {
          ignoreNumbers = [];
        }

        // Save org name & program title
        var orgName = document.getElementById("cfg-org-name").value.trim() || DEFAULT_ORG_NAME;
        var programTitle = document.getElementById("cfg-program-title").value.trim() || DEFAULT_PROGRAM_TITLE;
        localStorage.setItem("configOrgName", orgName);
        localStorage.setItem("configProgramTitle", programTitle);
        document.getElementById("org-name").innerText = orgName;
        document.getElementById("program-title").innerText = programTitle;

        // Save to localStorage
        localStorage.setItem("configData", JSON.stringify(valid));
        localStorage.setItem("configMax", String(MAX));
        localStorage.setItem("configIgnore", JSON.stringify(ignoreNumbers));

        // Clear old draw results (config changed)
        localStorage.removeItem("data");
        localStorage.removeItem("ignoreNumbers");

        // Rebuild data
        data = valid.map(function (p) {
          return {
            title: p.title,
            gift: p.gift,
            max: p.max,
            batch: p.batch || 1,
            highlight: p.highlight || 0,
            number: [],
          };
        });
        nowSpin = 0;

        // Update UI
        document.getElementById("title-spin").innerText = data[nowSpin].title;
        document.getElementById("title-value").innerText = data[nowSpin].gift;
        updateLists();
        updateCounter();
        for (var i = 1; i <= 5; i++) {
          var cell = document.getElementById("no" + i);
          cell.innerText = "0";
          cell.classList.remove("stopped", "spinning");
        }

        closeConfig();
      }

      function resetDefaults() {
        if (!confirm("Đặt lại tất cả về mặc định? Kết quả quay số sẽ bị xóa!"))
          return;
        configPrizes = DEFAULT_DATA.map(function (p) {
          return {
            title: p.title,
            gift: p.gift,
            max: p.max,
            batch: p.batch || 1,
            highlight: p.highlight || 0,
          };
        });
        document.getElementById("cfg-org-name").value = DEFAULT_ORG_NAME;
        document.getElementById("cfg-program-title").value = DEFAULT_PROGRAM_TITLE;
        document.getElementById("cfg-max").value = DEFAULT_MAX;
        document.getElementById("cfg-ignore").value = DEFAULT_IGNORE.join(", ");
        renderConfigTable();
      }

      // ============================
      // === FIREWORKS ENGINE ===
      // ============================
      var fireworksEnabled = true;
      var fwCanvas = document.getElementById("fireworks-canvas");
      var fwCtx = fwCanvas.getContext("2d");
      var fwParticles = [];
      var fwShells = [];
      var fwAnimId = null;
      var FW_GRAVITY = 0.06;
      var FW_COLORS = [
        "#ff0043",
        "#14fc56",
        "#1e7fff",
        "#e60aff",
        "#ffbf36",
        "#ffffff",
        "#ffd700",
        "#ff5252",
      ];

      function fwResize() {
        fwCanvas.width = window.innerWidth;
        fwCanvas.height = window.innerHeight;
      }
      fwResize();
      window.addEventListener("resize", fwResize);

      function toggleFireworks() {
        fireworksEnabled = !fireworksEnabled;
        var btn = document.getElementById("fireworksBtn");
        btn.classList.toggle("active", fireworksEnabled);
        if (fireworksEnabled) {
          fwLoop();
        } else {
          if (fwAnimId) cancelAnimationFrame(fwAnimId);
          fwAnimId = null;
          fwParticles = [];
          fwShells = [];
          fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
        }
      }

      function fwRandom(min, max) {
        return Math.random() * (max - min) + min;
      }

      function fwLaunchShell() {
        var x = fwRandom(fwCanvas.width * 0.15, fwCanvas.width * 0.85);
        var targetY = fwRandom(fwCanvas.height * 0.1, fwCanvas.height * 0.4);
        var color = FW_COLORS[Math.floor(Math.random() * FW_COLORS.length)];
        var secondColor =
          Math.random() < 0.4
            ? FW_COLORS[Math.floor(Math.random() * FW_COLORS.length)]
            : null;
        fwShells.push({
          x: x,
          y: fwCanvas.height,
          targetY: targetY,
          speed: fwRandom(4, 7),
          color: color,
          secondColor: secondColor,
          trail: [],
          size: fwRandom(2, 4),
        });
      }

      function fwExplode(shell) {
        var count = Math.floor(fwRandom(60, 120));
        var spread = fwRandom(2, 5);
        var useRing = Math.random() < 0.2;

        for (var i = 0; i < count; i++) {
          var angle, speed;
          if (useRing) {
            angle = (i / count) * Math.PI * 2;
            speed = spread * fwRandom(0.9, 1.1);
          } else {
            angle = Math.random() * Math.PI * 2;
            speed = Math.random() * spread;
          }
          var vx = Math.cos(angle) * speed;
          var vy = Math.sin(angle) * speed;
          var c =
            shell.secondColor && Math.random() < 0.35
              ? shell.secondColor
              : shell.color;
          var hasGlitter = Math.random() < 0.3;
          fwParticles.push({
            x: shell.x,
            y: shell.y,
            vx: vx,
            vy: vy,
            life: fwRandom(40, 80),
            maxLife: 80,
            color: c,
            size: shell.size * fwRandom(0.5, 1.2),
            alpha: 1,
            decay: fwRandom(0.012, 0.025),
            glitter: hasGlitter,
            trail: [],
          });
        }
      }

      var fwAutoTimer = 0;
      var fwAutoInterval = 60;
      var fwLastTime = 0;

      function fwLoop(timestamp) {
        if (!fireworksEnabled) return;
        fwAnimId = requestAnimationFrame(fwLoop);

        if (!timestamp) timestamp = 0;
        if (!fwLastTime) fwLastTime = timestamp;
        fwLastTime = timestamp;

        var w = fwCanvas.width;
        var h = fwCanvas.height;

        // Clear canvas (transparent - let background show through)
        fwCtx.clearRect(0, 0, w, h);
        fwCtx.globalCompositeOperation = "lighter";

        // Auto launch
        fwAutoTimer++;
        if (fwAutoTimer >= fwAutoInterval) {
          fwAutoTimer = 0;
          fwAutoInterval = Math.floor(fwRandom(35, 90));
          fwLaunchShell();
          // Occasionally launch 2-3 at once
          if (Math.random() < 0.3) fwLaunchShell();
          if (Math.random() < 0.1) fwLaunchShell();
        }

        // Update shells (comets going up)
        for (var i = fwShells.length - 1; i >= 0; i--) {
          var s = fwShells[i];
          s.trail.push({ x: s.x, y: s.y });
          if (s.trail.length > 8) s.trail.shift();

          s.y -= s.speed;
          s.x += fwRandom(-0.3, 0.3);

          // Draw comet trail
          for (var t = 0; t < s.trail.length; t++) {
            var trailAlpha = (t / s.trail.length) * 0.6;
            fwCtx.beginPath();
            fwCtx.arc(s.trail[t].x, s.trail[t].y, 1.5, 0, Math.PI * 2);
            fwCtx.fillStyle = "rgba(255, 200, 100, " + trailAlpha + ")";
            fwCtx.fill();
          }

          // Draw comet head
          fwCtx.beginPath();
          fwCtx.arc(s.x, s.y, 2.5, 0, Math.PI * 2);
          fwCtx.fillStyle = "#fff";
          fwCtx.fill();

          // Explode when reaching target
          if (s.y <= s.targetY) {
            fwExplode(s);
            fwShells.splice(i, 1);
          }
        }

        // Update particles
        for (var i = fwParticles.length - 1; i >= 0; i--) {
          var p = fwParticles[i];
          // Store trail position
          p.trail.push({ x: p.x, y: p.y });
          if (p.trail.length > 6) p.trail.shift();

          p.x += p.vx;
          p.y += p.vy;
          p.vy += FW_GRAVITY;
          p.vx *= 0.98;
          p.vy *= 0.98;
          p.alpha -= p.decay;
          p.life--;

          if (p.alpha <= 0 || p.life <= 0) {
            fwParticles.splice(i, 1);
            continue;
          }

          // Draw trail
          for (var j = 0; j < p.trail.length; j++) {
            var trailAlpha = (j / p.trail.length) * p.alpha * 0.4;
            var trailSize = p.size * (j / p.trail.length) * 0.8;
            fwCtx.globalAlpha = Math.max(0, trailAlpha);
            fwCtx.beginPath();
            fwCtx.arc(p.trail[j].x, p.trail[j].y, trailSize, 0, Math.PI * 2);
            fwCtx.fillStyle = p.color;
            fwCtx.fill();
          }

          // Draw particle
          fwCtx.globalAlpha = Math.max(0, p.alpha);
          fwCtx.beginPath();
          fwCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          fwCtx.fillStyle = p.color;
          fwCtx.fill();

          // Glitter sparkle
          if (p.glitter && Math.random() < 0.3) {
            fwCtx.beginPath();
            fwCtx.arc(p.x, p.y, p.size * 2, 0, Math.PI * 2);
            fwCtx.fillStyle = "#fff";
            fwCtx.globalAlpha = Math.max(0, p.alpha * 0.5);
            fwCtx.fill();
          }
        }

        fwCtx.globalAlpha = 1;
      }

      // Start fireworks on load
      fwLoop();
    </script>
  </body>
</html>
